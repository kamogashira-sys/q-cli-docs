# code-server マルチユーザー対応調査報告

**出典**: [code-server公式ドキュメント](https://coder.com/docs/code-server) - マルチユーザー対応ガイド

## 概要

AWS Samples AI Agent Development Code Server のマルチユーザー対応について、ポート競合問題と解決策を調査した結果をまとめます。code-serverは本来シングルユーザー設計であり、複数ユーザーでの同時利用には重大な制限があることが判明しました。

## 🚨 重要な発見

**AWS Samples AI Agent Development Code Server は、シングルユーザー設計であり、複数ユーザーでの同時利用には重大な制限があります。**

## 📋 ポート競合問題の詳細

### 基本設計の制限

- **デフォルトポート**: 8080（固定）
- **設定ファイル**: `~/.config/code-server/config.yaml`
- **シングルユーザー前提**: 1インスタンス1ユーザー設計

### 具体的な問題

| 状況 | 結果 | 影響 |
|------|------|------|
| **1ユーザー使用** | ✅ 正常動作 | 問題なし |
| **2ユーザー同時使用** | ❌ ポート競合エラー | 2番目のユーザーは起動不可 |
| **複数ユーザー順次使用** | ⚠️ 設定競合の可能性 | 設定ファイルの上書き |

## 🔧 マルチユーザー対応の4つのアプローチ

### 1. 異なるポートで複数インスタンス実行

**概要**: 同一サーバー上で各ユーザーに異なるポートを割り当て

```bash
# ユーザー1: ポート8080
code-server --bind-addr 0.0.0.0:8080 --auth password

# ユーザー2: ポート8081  
code-server --bind-addr 0.0.0.0:8081 --auth password

# ユーザー3: ポート8082
code-server --bind-addr 0.0.0.0:8082 --auth password
```

**メリット**:
- 1台のサーバーで複数ユーザー対応
- 設定が比較的簡単

**デメリット**:
- RAMの大量消費
- ファイル競合の可能性
- ユーザー数の制限（推奨5ユーザー以下）

### 2. Dockerコンテナで分離

**概要**: 各ユーザーに独立したDockerコンテナを提供

```bash
# ユーザー1用コンテナ
docker run -d -p 8080:8080 codercom/code-server:latest

# ユーザー2用コンテナ  
docker run -d -p 8081:8080 codercom/code-server:latest
```

**メリット**:
- 完全な分離環境
- ファイル競合なし
- 設定の独立性

**デメリット**:
- RAMの大量消費
- Docker管理の複雑さ

### 3. minikube/Kubernetes

**概要**: Kubernetesクラスターで各ユーザーにPodを割り当て

**メリット**:
- スケーラブル
- 本格的なオーケストレーション
- 本番環境への移行が容易

**デメリット**:
- Kubernetes知識が必要
- 設定の複雑さ
- 運用コストの増加

### 4. Coder（公式ソリューション）

**概要**: Coderプラットフォームを使用した統合管理

**メリット**:
- 公式サポート
- 認証・ユーザー管理機能
- 監査ログ機能
- 複数IDE対応

**デメリット**:
- Terraform知識が必要
- 追加ライセンスコスト
- 学習コストの増加

## 💰 コスト影響分析

### リソース使用量（ユーザーあたり）

| 項目 | シングルユーザー | マルチユーザー（5人） | 増加率 |
|------|-----------------|-------------------|--------|
| **CPU** | 2 vCPU | 2-4 vCPU | 100-200% |
| **メモリ** | 4GB | 8-16GB | 200-400% |
| **ストレージ** | 40GB | 100-200GB | 250-500% |

### 月額コスト試算（東京リージョン）

| 構成 | インスタンスタイプ | 月額コスト | 備考 |
|------|------------------|-----------|------|
| **シングルユーザー** | t4g.medium | 約3,600円 | 現在の構成 |
| **マルチユーザー（3人）** | t4g.large | 約7,200円 | メモリ8GB |
| **マルチユーザー（5人）** | t4g.xlarge | 約14,400円 | メモリ16GB |
| **Docker化（5人）** | m7g.large | 約10,800円 | 最適化構成 |

## 🚨 セキュリティ考慮事項

### 現在のリスク

1. **ファイルアクセス競合**
   - 複数ユーザーが同一ファイルシステムにアクセス
   - 意図しないファイル変更・削除の可能性

2. **プロセス分離不足**
   - ユーザー間でのプロセス干渉
   - リソース競合による不安定性

3. **認証情報の共有**
   - 同一パスワードでの複数アクセス
   - セキュリティ監査の困難さ

### 推奨セキュリティ対策

```bash
# 1. ユーザー分離
sudo adduser user1
sudo adduser user2

# 2. ホームディレクトリ制限  
sudo chmod 700 /home/user1
sudo chmod 700 /home/user2

# 3. 個別認証設定
# 各ユーザーに異なるパスワード設定
```

## 📊 実装優先度マトリックス

| アプローチ | 実装難易度 | コスト | スケーラビリティ | セキュリティ | 推奨度 |
|-----------|-----------|--------|-----------------|-------------|--------|
| **ポート分離** | ⭐ | ⭐⭐ | ⭐ | ⭐⭐ | 🥉 短期的 |
| **Docker化** | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 🥈 中期的 |
| **Kubernetes** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 🥇 長期的 |
| **Coder** | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🏆 企業レベル |

## 🎯 推奨アクションプラン

### フェーズ1: 即座の対応（1-2週間）

1. **現状の制限を明確化**
   - ユーザーにシングルユーザー設計であることを通知
   - 同時利用時の制限事項を説明

2. **暫定的なポート分離実装**
   - セキュリティグループでポート8080-8085を開放
   - 手動でのユーザー別ポート割り当て

### フェーズ2: 中期対応（1-2ヶ月）

1. **Docker化の実装**
   - Docker Composeによるマルチコンテナ構成
   - ユーザー別の独立環境構築

2. **自動化スクリプトの作成**
   - ユーザー追加の自動化
   - 環境セットアップの標準化

### フェーズ3: 長期対応（3-6ヶ月）

1. **Coderプラットフォームの評価**
   - PoC環境での検証
   - 企業要件との適合性確認

2. **本格的なマルチユーザー環境の構築**
   - 認証システムの統合
   - 監査ログの実装

## 📝 結論

### 主要な発見

1. **AWS Samples AI Agent Development Code Server は、マルチユーザー利用に適していない**
2. **ポート競合問題は確実に発生する**
3. **複数のユーザーで共有する場合は、追加の設計・実装が必要**

### 緊急度別推奨事項

#### 🚨 緊急（即座に対応）
- **ユーザーへの制限事項通知**
- **同時利用の禁止または制限**

#### ⚠️ 重要（1ヶ月以内）
- **ポート分離またはDocker化の実装**
- **ユーザー管理プロセスの確立**

#### 📋 計画的（3ヶ月以内）
- **本格的なマルチユーザー環境の検討**
- **Coderプラットフォームの評価**

### 最終推奨事項

**複数ユーザーでの利用を想定している場合は、AWS Samples AI Agent Development Code Server の使用を再検討し、より適切なマルチユーザー対応ソリューションの採用を強く推奨します。**

## 🔗 関連リンク

- **[code-server公式ドキュメント](https://coder.com/docs/code-server)**
- **[code-server マルチユーザー対応ガイド](https://coder.com/blog/code-server-multiple-users)**
- **[Coder プラットフォーム](https://coder.com/)**
- **[Docker による code-server 実装例](https://hub.docker.com/r/codercom/code-server)**

---

**最終更新**: 2025-12-30
