## 3. コンテキストの効果と特徴

### 3.1 コンテキストがもたらす効果

コンテキストを適切に設定することで、Q CLIとの対話が劇的に改善されます。

#### 3.1.1 応答精度の向上

**効果**: AIがプロジェクト固有の情報を理解し、より正確な回答を提供

**具体例**:

```markdown
# コンテキストなしの場合
ユーザー: "このプロジェクトのデプロイ方法を教えて"
AI: "一般的なデプロイ方法は..."（汎用的な回答）

# コンテキストありの場合（README.mdを読み込み）
ユーザー: "このプロジェクトのデプロイ方法を教えて"
AI: "このプロジェクトはAWS SAMを使用しています。
     sam build && sam deploy --guided でデプロイできます。"
```

💡 **初心者向けポイント**: コンテキストがあると、AIは「このプロジェクト」が何を指すのか理解できます。

#### 3.1.2 プロジェクト固有知識の活用

**効果**: プロジェクト独自のルール、命名規則、アーキテクチャを理解

**具体例**:

```markdown
# .amazonq/rules/naming.md を読み込んだ場合
ユーザー: "新しいLambda関数を作成して"
AI: "プロジェクトの命名規則に従い、
     {service}-{environment}-{function} の形式で作成します。
     例: user-service-prod-create-user"
```

💡 **初心者向けポイント**: プロジェクト固有のルールをコンテキストに含めることで、AIがそのルールに従ったコードを生成します。

#### 3.1.3 繰り返し説明の削減

**効果**: 毎回同じ説明をする必要がなくなる

**具体例**:

```markdown
# コンテキストなしの場合
ユーザー: "API仕様に従ってエンドポイントを追加して"
AI: "API仕様を教えてください"
ユーザー: "（API仕様を説明）"

# コンテキストありの場合（api-spec.mdを読み込み）
ユーザー: "API仕様に従ってエンドポイントを追加して"
AI: "api-spec.mdの仕様に従い、/api/v1/users エンドポイントを追加します"
```

💡 **初心者向けポイント**: 一度コンテキストに含めれば、毎回説明する必要がありません。

#### 3.1.4 開発効率の向上

**効果**: 質問と回答のやり取りが減り、開発速度が向上

**具体的な改善**:
- 質問回数: 平均3-5回 → 1-2回
- 回答精度: 60-70% → 85-95%
- 修正回数: 平均2-3回 → 0-1回

💡 **初心者向けポイント**: コンテキストの設定に5分かかっても、その後の開発で数時間節約できます。

---

### 3.2 Agent Resourcesの特徴

#### 3.2.1 永続性

**メリット**:
- Agent起動時に自動読み込み
- 毎回設定する必要がない
- チーム全体で共有可能

**デメリット**:
- 不要になっても自動削除されない
- 定期的な見直しが必要

**影響**:
- トークンを常時消費
- セッション開始時の読み込み時間

💡 **初心者向けポイント**: 「永続的」とは、Agentを使う限りずっと有効という意味です。

#### 3.2.2 自動読み込み

**メリット**:
- 手動操作不要
- 設定忘れがない
- 一貫性が保たれる

**デメリット**:
- 柔軟性が低い
- 不要な情報も読み込まれる可能性

**影響**:
- 初期設定が重要
- 設定ミスの影響が大きい

💡 **初心者向けポイント**: 自動読み込みは便利ですが、最初の設定を慎重に行う必要があります。

#### 3.2.3 トークン常時消費

**メリット**:
- すべての会話で利用可能
- 追加操作不要

**デメリット**:
- 使わない会話でもトークン消費
- トークン制限に達しやすい

**影響**:
- ファイル数とサイズの制限
- パフォーマンスへの影響

💡 **初心者向けポイント**: トークンは「AIが理解できる情報の量」です。常時消費するため、必要最小限にすることが重要です。

#### 3.2.4 適用場面

**最適な場面**:
1. **プロジェクト概要** - README.md
   - すべての会話で参照される
   - プロジェクトの基本情報

2. **プロジェクトルール** - .amazonq/rules/**/*.md
   - コーディング規約
   - 命名規則
   - アーキテクチャ原則

3. **API仕様** - api-spec.md
   - エンドポイント定義
   - データモデル

4. **アーキテクチャ図** - architecture.md
   - システム構成
   - コンポーネント関係

📝 **実例**: AWS SAMプロジェクトの基本設定

```json
{
  "resources": [
    "file://README.md",
    "file://.amazonq/rules/**/*.md",
    "file://template.yaml"
  ]
}
```

⚠️ **注意**: 頻繁に変更されるファイルは含めないでください。

---

### 3.3 Session Contextの特徴

#### 3.3.1 一時性

**メリット**:
- 必要な時だけ追加
- セッション終了で自動削除
- トークンの無駄がない

**デメリット**:
- 毎回手動で追加が必要
- 追加忘れの可能性

**影響**:
- 柔軟な運用が可能
- 操作の手間が増える

💡 **初心者向けポイント**: 「一時的」とは、そのチャットセッションだけで有効という意味です。

#### 3.3.2 手動管理

**メリット**:
- 完全なコントロール
- 状況に応じた調整
- 不要な情報を含めない

**デメリット**:
- コマンド操作が必要
- 管理の手間

**影響**:
- 運用コストの増加
- ミスの可能性

💡 **初心者向けポイント**: `/context add`コマンドで追加、`/context rm`コマンドで削除します。

#### 3.3.3 トークン常時消費

**メリット**:
- 追加後はすべての会話で利用可能

**デメリット**:
- 追加したら削除するまで消費し続ける
- 追加しすぎるとトークン制限に達する

**影響**:
- 定期的な確認が必要
- `/context show`での監視

💡 **初心者向けポイント**: Session Contextもトークンを常時消費します。不要になったら`/context rm`で削除しましょう。

#### 3.3.4 適用場面

**最適な場面**:
1. **一時的な調査** - 特定のファイルの分析
   - ログファイルの解析
   - 設定ファイルの確認

2. **特定タスク** - 機能開発中のみ必要な情報
   - 実装中のコード
   - 関連ドキュメント

3. **実験的な追加** - 効果を確認したい情報
   - 新しいルール
   - 参考資料

4. **大きなファイル** - 一時的に必要な大容量ファイル
   - データベーススキーマ
   - 詳細な仕様書

📝 **実例**: ログファイルの分析

```bash
# ログファイルを一時的に追加
/context add file://logs/error.log

# 分析
"このエラーの原因を教えて"

# 分析完了後、削除
/context rm file://logs/error.log
```

⚠️ **注意**: 使い終わったら必ず削除してください。トークンの無駄遣いになります。

---

### 3.4 Knowledge Basesの特徴

#### 3.4.1 永続性

**メリット**:
- 一度セットアップすれば永続的
- 大量のドキュメントを保存可能
- 自動更新（設定による）

**デメリット**:
- セットアップが必要
- 管理の手間

**影響**:
- 初期コストが高い
- 長期的には効率的

💡 **初心者向けポイント**: Knowledge Basesは「検索可能なドキュメント倉庫」です。

#### 3.4.2 セマンティック検索

**メリット**:
- 関連情報を自動検索
- キーワードマッチ以上の精度
- 大量のドキュメントから最適な情報を抽出

**デメリット**:
- 検索精度が完璧ではない
- 検索時間がかかる

**影響**:
- 応答時間の増加
- 検索結果の確認が必要

💡 **初心者向けポイント**: セマンティック検索は「意味で検索」します。完全一致でなくても関連情報を見つけられます。

#### 3.4.3 検索時のみトークン消費

**メリット**:
- 常時トークン消費なし
- トークン制限の影響を受けにくい
- 大量のドキュメントを扱える

**デメリット**:
- 検索しないと情報が使われない
- 明示的な検索が必要な場合がある

**影響**:
- トークン効率が高い
- 運用方法が異なる

💡 **初心者向けポイント**: Knowledge Basesは「必要な時だけ」トークンを使います。これが最大の利点です。

#### 3.4.4 適用場面

**最適な場面**:
1. **大量のドキュメント** - 10MB以上、数千ファイル
   - 技術ドキュメント
   - API仕様書
   - 過去のコード

2. **参照頻度が低い情報** - たまに必要な情報
   - トラブルシューティングガイド
   - 詳細な設計書
   - 過去のプロジェクト記録

3. **検索可能な情報** - キーワードで探せる情報
   - FAQ
   - ナレッジベース
   - ドキュメントライブラリ

4. **頻繁に更新される情報** - 定期的に変更される情報
   - 製品ドキュメント
   - API仕様
   - ベストプラクティス

📝 **実例**: 技術ドキュメントの管理

```bash
# Knowledge Baseのセットアップ
/knowledge add docs/

# 検索
/knowledge search "Lambda関数のベストプラクティス"

# 自動検索（質問に応じて自動的に検索）
"Lambda関数のエラーハンドリングはどうすればいい？"
```

⚠️ **注意**: Knowledge Basesは初期セットアップが必要です。まずは小規模から始めましょう。

---

### 3.5 制限事項と注意点

#### 3.5.1 トークン制限（75%）

**制限内容**:
- コンテキストは全トークンの75%まで
- 残り25%は会話と応答に使用

**影響**:
- ファイル数とサイズの制限
- 自動的にファイルがドロップされる可能性

**対策**:
1. `/context show`で定期的に確認
2. 不要なファイルを削除
3. Knowledge Basesへの移行を検討

💡 **初心者向けポイント**: 75%を超えると、AIが自動的にファイルを削除します。重要なファイルが削除される前に対策しましょう。

📝 **確認方法**:

```bash
/context show
# 出力例:
# Total tokens: 45000/60000 (75%)
# ⚠️ Context limit reached!
```

⚠️ **警告**: 75%に達したら、すぐに対策が必要です。

#### 3.5.2 ファイルサイズ制限

**推奨サイズ**:
- 1ファイル: 5000トークン以下（約20KB）
- 合計: 60000トークン以下（約240KB）

**大きすぎるファイルの問題**:
- トークン制限に達しやすい
- 読み込み時間が長い
- パフォーマンス低下

**対策**:
1. ファイルを分割
2. 要約版を作成
3. Knowledge Basesを使用

💡 **初心者向けポイント**: 1トークン ≈ 4文字（英語）、1トークン ≈ 2-3文字（日本語）が目安です。

📝 **ファイルサイズの確認**:

```bash
# ファイルサイズを確認
ls -lh README.md
# 出力例: -rw-r--r-- 1 user user 15K Oct 13 14:00 README.md

# トークン数の推定（日本語の場合）
# 15KB ≈ 15000文字 ≈ 5000-7500トークン
```

⚠️ **警告**: 10KB以上のファイルは分割を検討してください。

#### 3.5.3 サポートされるファイル形式

**サポート形式**:
- テキストファイル: .md, .txt, .json, .yaml, .yml
- コードファイル: .py, .js, .ts, .java, .go, .rs, etc.
- 設定ファイル: .env, .config, .ini

**非サポート形式**:
- バイナリファイル: .pdf, .docx, .xlsx
- 画像ファイル: .png, .jpg, .gif
- 圧縮ファイル: .zip, .tar.gz

**対策**:
1. テキスト形式に変換
2. 必要な部分を抽出
3. 別の方法で情報を提供

💡 **初心者向けポイント**: Q CLIは「テキストファイル」のみ読み込めます。

⚠️ **警告**: バイナリファイルを指定してもエラーになります。

#### 3.5.4 パフォーマンスへの影響

**影響要因**:
1. **ファイル数** - 多いほど遅い
   - 推奨: 10-20ファイル
   - 最大: 50ファイル

2. **ファイルサイズ** - 大きいほど遅い
   - 推奨: 1ファイル5000トークン以下
   - 最大: 1ファイル10000トークン

3. **合計サイズ** - 大きいほど遅い
   - 推奨: 合計30000トークン以下
   - 最大: 合計60000トークン（75%制限）

**パフォーマンス問題の症状**:
- Agent起動が遅い（10秒以上）
- 応答が遅い（5秒以上）
- メモリ使用量が高い

**対策**:
1. ファイル数を削減
2. ファイルサイズを削減
3. Knowledge Basesへの移行

💡 **初心者向けポイント**: 「速度」と「情報量」はトレードオフです。必要最小限を心がけましょう。

📝 **パフォーマンス測定**:

```bash
# Agent起動時間の測定
time q chat --agent my-agent

# 応答時間の確認
# チャット中に体感で確認
```

⚠️ **警告**: パフォーマンス問題が発生したら、すぐに最適化が必要です。

---

### 3.6 3つのアプローチの比較

#### 3.6.1 比較表

| 特徴 | Agent Resources | Session Context | Knowledge Bases |
|------|----------------|-----------------|-----------------|
| **永続性** | 永続的 | 一時的 | 永続的 |
| **読み込み** | 自動 | 手動 | 自動検索 |
| **トークン消費** | 常時 | 常時 | 検索時のみ |
| **管理方法** | 設定ファイル | コマンド | コマンド |
| **適用場面** | 常に必要な情報 | 一時的な情報 | 大量の情報 |
| **ファイル数** | 10-20推奨 | 1-5推奨 | 制限なし |
| **ファイルサイズ** | 小-中 | 小-中 | 大 |
| **セットアップ** | 簡単 | 不要 | 複雑 |
| **運用コスト** | 低 | 中 | 高 |

#### 3.6.2 選択基準

**Agent Resourcesを選ぶ場合**:
- ✅ すべての会話で必要
- ✅ ファイル数が少ない（10-20）
- ✅ ファイルサイズが小さい（5000トークン以下）
- ✅ 頻繁に変更されない

**Session Contextを選ぶ場合**:
- ✅ 特定の会話でのみ必要
- ✅ 一時的な情報
- ✅ 実験的に試したい
- ✅ 大きなファイルを一時的に使用

**Knowledge Basesを選ぶ場合**:
- ✅ ファイル数が多い（数百-数千）
- ✅ ファイルサイズが大きい（10MB以上）
- ✅ 検索可能な情報
- ✅ 参照頻度が低い

💡 **初心者向けポイント**: 迷ったら、まずAgent Resourcesから始めましょう。

#### 3.6.3 組み合わせパターン

**パターン1: 基本 + 一時**
```json
{
  "resources": [
    "file://README.md",
    "file://.amazonq/rules/**/*.md"
  ]
}
```
```bash
# 一時的に追加
/context add file://logs/error.log
```

**パターン2: 基本 + 検索**
```json
{
  "resources": [
    "file://README.md"
  ]
}
```
```bash
# Knowledge Baseをセットアップ
/knowledge add docs/
```

**パターン3: すべて組み合わせ**
```json
{
  "resources": [
    "file://README.md",
    "file://.amazonq/rules/**/*.md"
  ]
}
```
```bash
# 一時的に追加
/context add file://src/feature.py

# Knowledge Baseで検索
/knowledge search "エラーハンドリング"
```

💡 **初心者向けポイント**: 組み合わせることで、それぞれの利点を活かせます。

---

## まとめ

### 重要なポイント

1. **コンテキストの効果**
   - 応答精度の向上
   - 繰り返し説明の削減
   - 開発効率の向上

2. **3つのアプローチの特徴**
   - Agent Resources: 永続的、自動読み込み
   - Session Context: 一時的、手動管理
   - Knowledge Bases: 永続的、検索時のみトークン消費

3. **制限事項**
   - トークン制限: 75%
   - ファイルサイズ: 5000トークン推奨
   - パフォーマンスへの影響

4. **選択基準**
   - 使用頻度
   - ファイル数とサイズ
   - 管理コスト

### 次のステップ

第4章では、これらの特徴を踏まえた「ベストプラクティスの考え方」を学びます。

---

**出典**:
- [調査報告書](202510131418_context_best_practices_report.md)
- [AWS公式ドキュメント - Context management](https://docs.aws.amazon.com/amazonq/)
- [Agent機能ドキュメント](docs/01_for-users/02_features/02_agents.md)
