[ホーム](../../README.md) > [ユーザーガイド](../README.md) > [File Specifications](README.md) > 01 CLI Bash History

---

# .cli_bash_history ファイルフォーマット仕様書

**対象バージョン**: Amazon Q Developer CLI v1.18.1+  
**ソースコード**: `crates/chat-cli/src/util/directories.rs`, `crates/chat-cli/src/cli/chat/prompt.rs`, `crates/chat-cli/src/cli/chat/input_source.rs`  
**コミットハッシュ**: `63278298f451fd57ee439a2614bbac6a62da3870`  
**コミット日時**: 2025-10-13 12:44:25 -0700  
**ファイルパス**: `~/.aws/amazonq/.cli_bash_history`

---

## 📋 基本情報

| 項目 | 内容 |
|------|------|
| **ファイル名** | `.cli_bash_history` |
| **配置場所** | `~/.aws/amazonq/` |
| **フォーマット** | rustyline FileHistory v2 |
| **エンコーディング** | UTF-8 |
| **改行コード** | LF (`\n`) |
| **用途** | チャット履歴の永続化 |

---

## 🎯 目的

| 目的 | 説明 |
|------|------|
| **履歴の永続化** | チャットセッション間での入力履歴保存 |
| **履歴ヒント** | 入力補完のデータソース |
| **コマンド補完** | スラッシュコマンドの補完サポート |

---

## 📄 ファイル構造

### 全体構造

```
#V2
<履歴エントリ1>
<履歴エントリ2>
<履歴エントリ3>
...
```

### レコード仕様

| 行番号 | 要素 | 形式 | 必須 | 説明 |
|--------|------|------|------|------|
| 1 | ヘッダー | `#V2` | ✅ | フォーマットバージョン識別子 |
| 2〜 | 履歴エントリ | プレーンテキスト | ✅ | ユーザー入力（1行1エントリ） |

### ヘッダー仕様

| 項目 | 値 | 説明 |
|------|-----|------|
| **固定文字列** | `#V2` | rustyline FileHistory v2を示す |
| **位置** | 1行目 | ファイルの先頭 |
| **変更可否** | 不可 | 変更するとファイルが読み込めなくなる |

### 履歴エントリ仕様

| 項目 | 仕様 |
|------|------|
| **形式** | プレーンテキスト（1行1エントリ） |
| **文字数制限** | なし |
| **改行の扱い** | 改行文字がそのまま保存される |
| **エスケープ** | 不要（そのまま保存） |
| **空行** | 保存されない |

---

## 📝 保存される入力

### 保存対象

| 種類 | 例 | 保存 |
|------|-----|------|
| **通常のメッセージ** | `Pythonとは何ですか？` | ✅ |
| **スラッシュコマンド** | `/help`, `/clear`, `/quit` | ✅ |
| **複数行入力** | `## タイトル\n\n内容` | ✅ |
| **空行** | ` ` (空白のみ) | ❌ |
| **改行のみ** | `\n` | ❌ |

### 保存条件

| 条件 | 判定 |
|------|------|
| 空文字列 | 保存しない |
| 空白のみ | 保存しない |
| 1文字以上の内容 | 保存する |

---

## 💻 実装詳細

### 使用ライブラリ

| 項目 | 内容 |
|------|------|
| **ライブラリ** | rustyline |
| **モジュール** | `rustyline::history::FileHistory` |
| **バージョン** | Cargo.tomlで指定 |

### 主要API

| API | 用途 | ファイル |
|-----|------|---------|
| `load_history()` | 履歴の読み込み | `prompt.rs` |
| `add_history_entry()` | 履歴の追加 | `input_source.rs` |
| `append_history()` | 履歴の保存 | `input_source.rs` |

### ソースコード参照

| 機能 | ファイルパス | 行番号 |
|------|-------------|--------|
| パス定義 | `crates/chat-cli/src/util/directories.rs` | 50, 165-166 |
| 履歴読み込み | `crates/chat-cli/src/cli/chat/prompt.rs` | 18, 470, 502 |
| 履歴保存 | `crates/chat-cli/src/cli/chat/input_source.rs` | 55, 103-104, 119, 136 |

---

## 🔧 ファイル操作

### 基本操作

| 操作 | コマンド | 説明 |
|------|---------|------|
| **全履歴表示** | `cat ~/.aws/amazonq/.cli_bash_history` | 全エントリを表示 |
| **最新10件** | `tail -10 ~/.aws/amazonq/.cli_bash_history` | 最新10エントリ |
| **履歴件数** | `wc -l ~/.aws/amazonq/.cli_bash_history` | 総行数（ヘッダー含む） |
| **履歴削除** | `rm ~/.aws/amazonq/.cli_bash_history` | ファイル削除 |
| **履歴初期化** | `echo "#V2" > ~/.aws/amazonq/.cli_bash_history` | 空ファイル作成 |

### 検索操作

| 操作 | コマンド | 説明 |
|------|---------|------|
| **キーワード検索** | `grep "Python" ~/.aws/amazonq/.cli_bash_history` | 特定文字列を含む履歴 |
| **正規表現検索** | `grep -E "^/[a-z]+" ~/.aws/amazonq/.cli_bash_history` | スラッシュコマンドのみ |
| **大文字小文字無視** | `grep -i "python" ~/.aws/amazonq/.cli_bash_history` | 大文字小文字を区別しない |

---

## 🎨 実例

### サンプルファイル

```
#V2
こんにちは、Q！
Pythonとは何ですか？
/help
S3バケットの作成方法を教えてください
Create a Python script that prints "Hello, World!"
/clear
AWS CLIのインストール方法は？
```

### エントリ種別の例

| 種別 | 実例 |
|------|------|
| **質問** | `Pythonとは何ですか？` |
| **依頼** | `S3バケットの作成方法を教えてください` |
| **英語入力** | `Create a Python script that prints "Hello, World!"` |
| **コマンド** | `/help` |
| **複数行** | `## 推奨案\n\n詳細な作業計画を作成して` |

---

## 🔐 セキュリティ

### 含まれる可能性のある情報

| 情報種別 | リスク | 対策 |
|---------|--------|------|
| **質問内容** | プロジェクト情報の漏洩 | 機密情報を含む質問を避ける |
| **コマンド履歴** | ファイルパスの露出 | 定期的な履歴クリーンアップ |
| **技術的課題** | ビジネスロジックの推測 | 抽象的な質問を心がける |

### 推奨設定

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| **ファイルパーミッション** | `600` | 所有者のみ読み書き可能 |
| **バージョン管理** | 除外 | `.gitignore`に追加 |
| **定期クリーンアップ** | 月次 | 古い履歴の削除 |

---

## ⚙️ 履歴ヒント機能

### 設定

| 項目 | 内容 |
|------|------|
| **設定名** | `chat.enableHistoryHints` |
| **デフォルト** | `false` |
| **有効化コマンド** | `q settings chat.enableHistoryHints true` |

### 動作仕様

| 項目 | 内容 |
|------|------|
| **トリガー** | 入力開始時 |
| **マッチング** | 前方一致 |
| **データソース** | `.cli_bash_history` |
| **表示** | 過去の履歴から候補を表示 |

---

## 🔄 ライフサイクル

### ファイル作成

| タイミング | 動作 |
|-----------|------|
| **初回起動時** | ファイルが存在しない場合に作成 |
| **親ディレクトリ不在** | `~/.aws/amazonq/`を自動作成 |

### ファイル更新

| タイミング | 動作 |
|-----------|------|
| **チャット終了時** | `append_history()`で追記 |
| **既存履歴** | 保持される（上書きしない） |

### ファイル削除

| 方法 | 動作 |
|------|------|
| **手動削除** | ユーザーが`rm`コマンドで削除 |
| **自動削除** | Q CLIは自動削除しない |

---

## 🐛 トラブルシューティング

### 履歴が保存されない

| 原因 | 対処方法 |
|------|---------|
| **ディレクトリ権限不足** | `chmod 700 ~/.aws/amazonq` |
| **ディスク容量不足** | 不要なファイルを削除 |
| **ファイルシステムエラー** | `dmesg`でエラー確認 |

### 履歴が読み込まれない

| 原因 | 対処方法 |
|------|---------|
| **ヘッダー欠落** | `head -1`で確認、`#V2`を追加 |
| **ファイル破損** | バックアップから復元、または初期化 |
| **エンコーディング不正** | UTF-8に変換 |

### 診断コマンド

| 確認項目 | コマンド |
|---------|---------|
| **ファイル存在確認** | `ls -la ~/.aws/amazonq/.cli_bash_history` |
| **ヘッダー確認** | `head -1 ~/.aws/amazonq/.cli_bash_history` |
| **権限確認** | `stat ~/.aws/amazonq/.cli_bash_history` |
| **エンコーディング確認** | `file ~/.aws/amazonq/.cli_bash_history` |

---

## 📚 関連ファイル

| ファイル | 用途 | 関連性 |
|---------|------|--------|
| `~/.aws/amazonq/history/` | チャット会話履歴 | 別形式（会話全体） |
| `~/.aws/amazonq/cli-checkpoints/` | チェックポイント | 別機能 |
| `~/.bash_history` | システムbash履歴 | 無関係 |

---

## 📖 参考情報

### 公式ドキュメント

| リソース | URL |
|---------|-----|
| **rustyline crate** | https://docs.rs/rustyline/ |
| **FileHistory** | https://docs.rs/rustyline/latest/rustyline/history/struct.FileHistory.html |
| **Q CLI GitHub** | https://github.com/aws/amazon-q-developer-cli |

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-10-24 | 1.0 | 初版作成 |
| 2025-10-24 | 1.1 | 表形式に再構成、可読性向上 |

---

**作成者**: Amazon Q Developer CLI  
**調査方法**: ソースコード解析 + 実ファイル確認

---
最終更新: 2025-11-01
