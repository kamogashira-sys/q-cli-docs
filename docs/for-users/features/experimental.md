# 実験的機能

**最終更新**: 2025-10-11  
**対象バージョン**: v1.17.0以降

---

## 📋 目次

- [実験的機能とは](#実験的機能とは)
- [Context Usage Indicator](#context-usage-indicator)
- [Thinking（思考過程表示）](#thinking思考過程表示)
- [Delegate Mode](#delegate-mode)
- [注意事項](#注意事項)

---

## 🧪 実験的機能とは

実験的機能は、開発中の新機能を早期に試すことができる機能です。

### 特徴
- **不安定**: 予告なく変更される可能性があります
- **フィードバック歓迎**: 使用感を[GitHub Issues](https://github.com/aws/amazon-q-developer-cli/issues)で報告してください
- **段階的リリース**: 安定後に正式機能として組み込まれます

### 有効化方法

**方法1: `/experiment`コマンドを使用（推奨）**

```
> /experiment
```

表示されるメニューから有効化したい機能を選択してON/OFFを切り替えます。

**方法2: 設定コマンドを使用**

```bash
# 設定ファイルで有効化
q settings edit

# または、コマンドで有効化
q settings set <設定キー> true
```

---

## 🔍 実験的機能の比較

どの機能を使うべきか迷ったら、この比較表を参考にしてください。

| 機能 | 安定性 | 用途 | 推奨度 | 学習コスト | 対象ユーザー |
|------|--------|------|--------|-----------|-------------|
| Context Usage Indicator | ベータ | パフォーマンス監視 | ★★★★★ | 低 | すべて |
| Thinking | アルファ | デバッグ・学習 | ★★★☆☆ | 中 | 中級者以上 |
| Delegate Mode | アルファ | 自動化 | ★★☆☆☆ | 高 | 上級者のみ |

### 推奨度の基準

- **★★★★★**: すべてのユーザーに推奨。安定性が高く、すぐに役立つ
- **★★★☆☆**: 中級者以上に推奨。使いこなすには理解が必要
- **★★☆☆☆**: 上級者のみ推奨。リスクを理解した上で使用

### 安定性レベル

- **ベータ**: 基本機能は安定。細かい変更の可能性あり
- **アルファ**: 開発中。大きな変更の可能性あり

### 選択ガイド

#### 初心者の方
まずは**Context Usage Indicator**から始めましょう。
```bash
q settings set chat.enableContextUsageIndicator true
```

#### 中級者の方
**Thinking**を有効にして、AIの思考過程を学びましょう。
```bash
q settings set chat.enableThinking true
```

#### 上級者の方
**Delegate Mode**で複雑なタスクを自動化できます。
```bash
q settings set chat.enableDelegate true
```

---

## 📊 Context Usage Indicator

### 概要
コンテキスト使用率をリアルタイムで表示する機能です。

### 実現される機能
- **トークン使用量の可視化**: 現在のトークン数を表示
- **使用率の監視**: 最大トークン数に対する割合を表示
- **警告表示**: 上限に近づくと警告を表示

### 有効化

**方法1: `/experiment`コマンドを使用（推奨）**

```
> /experiment
```

メニューから「Context Usage Indicator」を選択してONに切り替えます。

**方法2: 設定コマンドを使用**

```bash
q settings set chat.enableContextUsageIndicator true
```

### 使用例

#### 表示内容
会話中に使用率が表示されます：

```
┌─────────────────────────────────────┐
│ Context Usage: 6,234 / 8,000 (78%) │
└─────────────────────────────────────┘

You: このコードをレビューして

Assistant: こちらがコードレビューです...

┌─────────────────────────────────────┐
│ Context Usage: 7,891 / 8,000 (99%) │ ⚠️ 警告
└─────────────────────────────────────┘
```

#### 活用シーン

**シーン1: 長い会話の管理**
```
# チャット内で使用率を確認（プロンプトに表示される）
[default] 30% > 現在のコンテキスト使用率は？

# 上限に近づいたら/compactで要約
[default] 85% > /compact
```

**シーン2: 大きなファイルの処理**
```
# チャット内で大きなファイルを読み込む前に確認
[default] 30% > このファイルを読み込むとコンテキストはどのくらい使う？
```

**シーン3: パフォーマンス最適化**
```
# 使用率が高い場合は/compactで要約
[default] 75% > /compact
```

### トラブルシューティング

#### 表示されない場合
```bash
# 設定を確認
q settings show chat.enableContextUsageIndicator

# 再起動
q restart
```

#### 使用率が100%に達した場合
```
# チャットセッション内で実行
> /clear          # 会話履歴をクリア
> /compact        # コンテキストを要約して圧縮
> /quit           # セッションを終了（新規セッションは再度 q chat で開始）
```

---

## 🧠 Thinking（思考過程表示）

### 概要
AIの思考過程をリアルタイムで表示する機能です。

### 実現される機能
- **思考の可視化**: AIがどう考えているかを表示
- **判断理由の理解**: なぜその回答になったかを理解
- **デバッグ支援**: 期待と異なる回答の原因を特定

### 有効化

**方法1: `/experiment`コマンドを使用（推奨）**

```
> /experiment
```

メニューから「Thinking」を選択してONに切り替えます。

**方法2: 設定コマンドを使用**

```bash
q settings set chat.enableThinking true
```

### 使用例

#### 表示内容
```
You: Pythonで素数判定関数を作って

💭 Thinking...
  1. 素数判定のアルゴリズムを検討
     - 試し割り法: シンプルだが遅い
     - エラトステネスの篩: 高速だが大量の数には不向き
     - ミラー・ラビン法: 確率的だが高速
  
  2. ユーザーの要件を推測
     - 教育目的 → シンプルな実装
     - 本番環境 → 高速な実装
     - 要件不明 → 汎用的な実装を提案
  
  3. 実装方針の決定
     - 試し割り法をベースに最適化
     - 2と偶数を特別扱い
     - √nまでチェック

Assistant: 素数判定関数を作成します...
```

#### 活用シーン

**シーン1: デバッグ**
期待と異なる回答が返ってきた場合、思考過程を確認して原因を特定

**シーン2: 学習**
AIの問題解決アプローチを学ぶ

**シーン3: 検証**
AIの判断が適切かを確認

### 有効/無効の切り替え
```bash
# 有効化
q settings set chat.enableThinking true

# 無効化
q settings set chat.enableThinking false

# 現在の設定を確認
q settings show chat.enableThinking
```

---

## 🤖 Delegate Mode

### 概要
複雑なタスクをAIに委譲し、自律的に実行させるモードです。

> **⚠️ 重要な安全性に関する警告**
> 
> Delegate Modeは強力な機能ですが、以下の点に十分注意してください：
> 
> - **ファイル操作**: AIが自動的にファイルを作成・変更・削除する可能性があります
> - **コマンド実行**: システムコマンドが自動実行される場合があります
> - **外部アクセス**: ネットワーク経由で外部サービスにアクセスする可能性があります
> - **本番環境での使用禁止**: 開発環境でのみ使用してください
> - **バックアップ必須**: 重要なファイルは事前にバックアップしてください
> - **権限の最小化**: Agent設定で必要最小限の権限のみを付与してください
> 
> **推奨される使用環境:**
> - 開発環境またはテスト環境
> - Gitなどのバージョン管理システムで管理されているプロジェクト
> - 重要なデータのバックアップが取られている環境

### 実現される機能
- **複数ステップの自動実行**: タスクを分解して順次実行
- **中間結果の確認**: 各ステップの結果を確認しながら進行
- **エラー時の自動リトライ**: 失敗時に自動的に再試行

### 有効化

**方法1: `/experiment`コマンドを使用（推奨）**

```
> /experiment
```

メニューから「Delegate」を選択してONに切り替えます。

**方法2: 設定コマンドを使用**

```bash
q settings set chat.enableDelegate true
```

### 安全な使用のためのベストプラクティス

#### 1. Agent設定での権限制限
```json
{
  "name": "safe-delegate-agent",
  "tools": [
    "fs_read",      // 読み取りのみ許可
    "execute_bash"  // 必要な場合のみ
  ],
  "allowedPaths": [
    "/home/user/projects/test-project"  // 特定のディレクトリのみ
  ]
}
```

#### 2. 基本的な使用方法
```
# チャットセッション内でAIに依頼
> rust-agentにsnake gameを作成するタスクを委任して

# AIがDelegateツールを呼び出し、バックグラウンドで実行される
```

#### 3. ステータス確認
```
# 特定のエージェントのステータスを確認
> rust-agentのステータスを確認して

# 全エージェントのステータスを確認
> 全エージェントのステータスを確認して
```

#### 4. 利用可能なエージェント一覧
```
# 利用可能なエージェントを表示
> 利用可能なエージェントを一覧表示して
```

### 実行フロー

```
1. タスク受領
   ↓
2. タスク分解
   ↓
3. ステップ1実行
   ↓
4. 結果確認
   ↓
5. ステップ2実行
   ↓
6. ...
   ↓
7. 完了報告
```

### 具体的な使用例

#### 例1: テストコード作成
```bash
You: このプロジェクトのテストを作成して

💼 Delegate Mode: タスクを分析中...

ステップ1: プロジェクト構造を分析
✓ 完了: 3つのモジュールを検出

ステップ2: 各モジュールのテストを作成
✓ 完了: module1_test.py 作成
✓ 完了: module2_test.py 作成
✓ 完了: module3_test.py 作成

ステップ3: テストを実行
✓ 完了: すべてのテストが通過

📊 タスク完了: 3つのテストファイルを作成しました
```

#### 例2: ドキュメント生成
```bash
You: このAPIのドキュメントを作成して

💼 Delegate Mode: タスクを分析中...

ステップ1: APIエンドポイントを抽出
✓ 完了: 5つのエンドポイントを検出

ステップ2: 各エンドポイントのドキュメントを作成
✓ 完了: GET /users
✓ 完了: POST /users
✓ 完了: GET /users/{id}
✓ 完了: PUT /users/{id}
✓ 完了: DELETE /users/{id}

ステップ3: OpenAPI仕様書を生成
✓ 完了: openapi.yaml 作成

📊 タスク完了: APIドキュメントを作成しました
```

#### 例3: リファクタリング
```bash
You: このコードをリファクタリングして

💼 Delegate Mode: タスクを分析中...

ステップ1: コードの問題点を特定
✓ 完了: 3つの改善点を検出
  - 重複コードの削減
  - 関数の分割
  - 型ヒントの追加

ステップ2: リファクタリングを実施
✓ 完了: 重複コードを共通関数に抽出
✓ 完了: 長い関数を3つに分割
✓ 完了: 型ヒントを追加

ステップ3: テストを実行
✓ 完了: すべてのテストが通過

📊 タスク完了: リファクタリングが完了しました
```

#### 例4: バグ修正
```bash
You: このバグを修正して

💼 Delegate Mode: タスクを分析中...

ステップ1: バグの原因を特定
✓ 完了: NullPointerExceptionを検出

ステップ2: 修正方法を検討
✓ 完了: null チェックを追加

ステップ3: 修正を実施
✓ 完了: コードを修正

ステップ4: テストを実行
✓ 完了: バグが修正されました

📊 タスク完了: バグ修正が完了しました
```

#### 例5: データ分析
```bash
You: このCSVファイルを分析して

💼 Delegate Mode: タスクを分析中...

ステップ1: データを読み込み
✓ 完了: 1,000行のデータを読み込み

ステップ2: 基本統計を計算
✓ 完了: 平均、中央値、標準偏差を計算

ステップ3: 可視化を作成
✓ 完了: ヒストグラムを作成
✓ 完了: 散布図を作成

ステップ4: レポートを生成
✓ 完了: analysis_report.md 作成

📊 タスク完了: データ分析が完了しました
```

### 制限事項と注意点

#### 制限事項
- **実行時間**: 長時間かかるタスクはタイムアウトする可能性があります
- **外部依存**: 外部サービスへのアクセスが必要な場合、適切な権限が必要です
- **ファイルアクセス**: Agent設定で許可されたパスのみアクセス可能です

#### 安全性に関する注意点
- **⚠️ 破壊的操作のリスク**: ファイルの削除や上書きが発生する可能性があります
- **⚠️ 意図しないコマンド実行**: システムに影響を与えるコマンドが実行される可能性があります
- **⚠️ データ損失のリスク**: バックアップなしでの使用は避けてください
- **⚠️ セキュリティリスク**: 機密情報を含むタスクには使用しないでください

#### 一般的な注意点
- **確認**: 重要な操作の前に確認を求めることがあります
- **エラー処理**: エラーが発生した場合、自動リトライしますが、失敗する可能性があります
- **リソース**: 複雑なタスクは多くのリソースを消費します

### トラブルシューティング

#### タスクが進まない場合
```
# チャットセッション内でステータスを確認
> エージェントのステータスを確認して

# ログを確認（別ターミナルで）
tail -f ~/.local/share/amazon-q/logs/q-cli.log
```

#### タイムアウトする場合
```bash
# タイムアウト時間を延長
q settings set chat.delegateTimeout 600
```

---

## ⚠️ 注意事項

### 一般的な注意事項
- 実験的機能は予告なく変更される可能性があります
- 本番環境での使用は推奨されません
- フィードバックは[GitHub Issues](https://github.com/aws/amazon-q-developer-cli/issues)で報告してください

### パフォーマンスへの影響
- Context Usage Indicator: 軽微な影響
- Thinking: 応答時間が若干増加
- Delegate Mode: タスクの複雑さに応じて時間がかかります

### プライバシーとセキュリティ
- 実験的機能の使用状況は、機能改善のために収集される場合があります
- 機密情報を含むタスクには注意してください

---

## 📚 関連ドキュメント

- [チャット機能](chat.md) - 基本的なチャット機能
- [Agent機能](agents.md) - Agent設定
- [設定ガイド](../configuration/README.md) - 設定方法
- [トラブルシューティング](../troubleshooting/common-issues.md) - 問題解決

---

**作成日**: 2025-10-11  
**最終更新**: 2025-10-11