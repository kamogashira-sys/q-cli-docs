# インシデント報告書 - 2025-10-26

## 🚨 インシデント概要

**発生日時**: 2025-10-25 18:49:23  
**発見日時**: 2025-10-26 06:17:21  
**重大度**: **高（サイト信頼性を損なう重大な瑕疵）**  
**影響範囲**: 4ファイル、18箇所の誤ったコマンド記載

---

## 📋 インシデント詳細

### 誤った記載内容

| カテゴリ | 誤った記載 | 正しい記載 | 箇所数 |
|---------|-----------|-----------|--------|
| **存在しないコマンド** | `q knowledge add/show` | `/knowledge add/show`（チャット内コマンド） | 3箇所 |
| **誤ったサブコマンド** | `q settings set/edit/show/all` | `q settings/open/list` | 9箇所 |
| **誤ったオプション** | `q agent edit <name>` | `q agent edit --name <name>` | 2箇所 |
| **誤った省略形** | `q --agent` | `q chat --agent` | 2箇所 |
| **誤ったサブコマンド** | `q agent use` | `q agent set-default` | 1箇所 |
| **合計** | - | - | **18箇所** |

### 影響を受けたファイル

1. `docs/03_for-community/01_updates/04_migration-guides.md` - **最も深刻**
2. `docs/01_for-users/10_file-specifications/04_global-settings.md`
3. `docs/01_for-users/10_file-specifications/02_agent-configuration.md`
4. `docs/01_for-users/08_guides/09_workflow-automation.md`

---

## 🔍 根本原因分析

### 原因1: チャット内コマンドとCLIコマンドの混同【最重要】

**問題の本質**:
- `/knowledge`は**チャット内コマンド**（`q chat`実行後に使用）
- `q knowledge`という**CLIコマンドは存在しない**
- この区別が理解されていなかった

**証拠**:
```bash
# 正しい使い方
q chat                    # チャットを開始
> /knowledge add ...      # チャット内でknowledgeコマンドを実行

# 誤った記載（存在しない）
q knowledge add ...       # このようなCLIコマンドは存在しない
```

**参照ドキュメント**:
- `docs/01_for-users/07_reference/02_commands.md`には`/knowledge`として記載
- チャット内コマンドは`/`で始まる
- CLIコマンドは`q`で始まる

**なぜ混同したか**:
1. v1.19.0のリリースノートで「Knowledge PDF対応」が追加された
2. 既存ドキュメント（`02_commands.md`）に`/knowledge`コマンドが記載されていた
3. これを**CLIコマンド**として誤解し、`q knowledge`と記載した
4. GitHubソースを直接確認せず、推測で記載した

---

### 原因2: `q settings`サブコマンドの推測

**問題の本質**:
- `q settings`の実際のサブコマンドは`open`と`list`のみ
- `set`, `edit`, `show`, `all`は存在しない
- 一般的なCLIツールの慣習から推測して記載した

**証拠**:
```bash
# 実際のコマンド（q settings --help）
q settings <key> <value>  # 設定
q settings <key>          # 確認
q settings --delete <key> # 削除
q settings open           # ファイルを開く
q settings list           # 一覧表示

# 誤った記載（存在しない）
q settings set <key> <value>  # "set"は不要
q settings edit               # "open"が正しい
q settings show               # "list"が正しい
q settings all                # "list"が正しい
```

**なぜ推測したか**:
1. 他のCLIツール（git, npm等）では`set`, `edit`, `show`が一般的
2. Q CLIの実際の仕様を`q settings --help`で確認しなかった
3. 「こうあるべき」という思い込みで記載した

---

### 原因3: オプション指定の確認不足

**問題の本質**:
- `q agent edit`は`--name`オプションが必須
- 位置引数では動作しない
- `q agent --help`で確認すれば判明する内容

**証拠**:
```bash
# 実際のコマンド（q agent edit --help）
q agent edit --name <NAME>

# 誤った記載
q agent edit <name>
q agent edit my-agent
```

**なぜ確認しなかったか**:
1. 他のコマンド（`q chat --agent <name>`）の類推で記載
2. 実際に`q agent edit --help`を実行して確認しなかった
3. 「位置引数で動くだろう」という推測

---

### 原因4: ドキュメント作成プロセスの欠陥

**問題の本質**:
- GitHubソースを参照せず、推測で記載
- コマンドの実行確認を行わなかった
- レビュープロセスが不十分

**作成プロセスの問題点**:

| ステップ | 実施すべきこと | 実際に行ったこと | 問題 |
|---------|--------------|----------------|------|
| 1. 情報収集 | GitHubソースを確認 | リリースノートのみ確認 | ❌ ソース未確認 |
| 2. コマンド確認 | `q --help`で実行確認 | 確認せず推測で記載 | ❌ 実行未確認 |
| 3. 記載 | 確認した内容のみ記載 | 推測で記載 | ❌ 推測記載 |
| 4. レビュー | コマンド実行テスト | レビューなし | ❌ テスト未実施 |

---

## 🎯 根本原因まとめ

### 直接原因
1. **チャット内コマンドとCLIコマンドの混同**
   - `/knowledge`（チャット内）を`q knowledge`（CLI）と誤解
   
2. **コマンド仕様の推測**
   - `q settings set/edit/show/all`を一般的な慣習から推測
   - `q agent edit <name>`を位置引数で動作すると推測

3. **確認作業の欠如**
   - `q --help-all`で確認しなかった
   - 各サブコマンドの`--help`を確認しなかった
   - 実際にコマンドを実行して動作確認しなかった

### 根本原因（最重要）

**「GitHubソースを参照せず、推測でドキュメントを作成した」**

#### なぜ推測で記載したか

1. **時間的プレッシャー**
   - v1.19.0リリース直後に迅速にドキュメント化しようとした
   - 確認作業を省略した

2. **過信**
   - 「一般的なCLIツールの慣習に従っているだろう」という思い込み
   - 「他のコマンドと同じ構文だろう」という類推

3. **プロセスの不備**
   - コマンド記載時の確認手順が確立されていなかった
   - レビュープロセスが不十分だった
   - 自動検証の仕組みがなかった

4. **情報源の誤解**
   - リリースノートに「Knowledge PDF対応」とあったため、`q knowledge`コマンドが追加されたと誤解
   - 既存ドキュメント（`02_commands.md`）の`/knowledge`を見落とした

---

## 📊 影響範囲

### 信頼性への影響
- ✅ **ユーザーが実行できないコマンドを記載** → 信頼性の喪失
- ✅ **公式ドキュメントとの乖離** → 混乱を招く
- ✅ **サイト全体の信頼性への疑念** → 他の記載も正確か疑われる

### 発見された問題の範囲
- ❌ **v1.19.0マイグレーションガイド**: 最も深刻（新規ユーザーが参照）
- ❌ **ファイル仕様書**: 技術的な参照ドキュメント
- ❌ **ワークフロー自動化ガイド**: 実践的なガイド

---

## 🔧 即座に実施した対応

### 修正内容（2025-10-26 06:17-06:30）

1. **存在しないコマンドの削除**
   - `q knowledge`コマンドを削除
   - Knowledge機能の正しい説明に変更

2. **誤ったサブコマンドの修正**
   - `q settings set/edit/show/all` → 正しいコマンドに修正

3. **オプション指定の修正**
   - `q agent edit <name>` → `q agent edit --name <name>`

4. **省略形の修正**
   - `q --agent` → `q chat --agent`

**修正コミット**: `30d5b2b`

---

## 🚨 未解決の懸念

### 他のドキュメントにも同様の問題がある可能性

以下のカテゴリで推測記載の可能性：

1. **コマンド関連**
   - 全てのコマンド例が実行可能か？
   - オプション指定が正確か？
   - サブコマンドが存在するか？

2. **設定ファイル仕様**
   - JSONスキーマと一致しているか？
   - 環境変数名が正確か？
   - デフォルト値が正しいか？

3. **機能説明**
   - 実装されていない機能を記載していないか？
   - バージョン情報が正確か？
   - 動作説明が実際の挙動と一致しているか？

4. **トラブルシューティング**
   - 解決方法が実際に有効か？
   - エラーメッセージが正確か？

---

## 📝 教訓

### 絶対に守るべき原則

1. **推測で記載しない**
   - 必ずGitHubソースを確認
   - 必ず実際にコマンドを実行して確認
   - 不明な点は記載しない

2. **チャット内コマンドとCLIコマンドを区別する**
   - `/`で始まる → チャット内コマンド
   - `q`で始まる → CLIコマンド
   - 混同しない

3. **確認手順の徹底**
   - `q --help-all`で全コマンドを確認
   - `q <subcommand> --help`で詳細を確認
   - 実際に実行して動作確認

4. **レビュープロセスの確立**
   - コマンド記載時は必ず実行確認
   - 自動検証スクリプトの導入
   - pre-commitフックでの検証

---

## 🔮 再発防止策（次のセクションで詳細計画）

### 短期対策（即座に実施）
1. サイト全体のコマンド検証
2. 推測記載の洗い出し
3. 自動検証スクリプトの作成

### 中期対策（1週間以内）
1. ドキュメント作成ガイドラインの策定
2. レビューチェックリストの作成
3. CI/CDパイプラインへの検証組み込み

### 長期対策（1ヶ月以内）
1. 定期的な全体検証の自動化
2. GitHubソースとの自動同期チェック
3. コミュニティレビューの導入

---

## 📅 タイムライン

| 日時 | イベント |
|------|---------|
| 2025-10-25 18:49 | 誤ったコマンドを含むマイグレーションガイドをコミット |
| 2025-10-26 06:17 | インシデント発見 |
| 2025-10-26 06:30 | 緊急修正完了（18箇所） |
| 2025-10-26 06:40 | 根本原因分析完了 |
| 2025-10-26 06:45 | 水平展開計画作成（予定） |

---

*このインシデントを重く受け止め、サイト全体の信頼性回復に全力を尽くします。*
